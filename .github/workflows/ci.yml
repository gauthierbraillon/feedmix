name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with race detector and coverage
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: coverage.out
          fail_ci_if_error: false

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Fetch latest YouTube API schema
        run: |
          curl -sf https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest \
            -o pkg/contracts/youtube-discovery.json || echo "Failed to fetch schema, using committed version"

      - name: Run contract tests
        run: go test -v ./pkg/contracts/...

  integration-tests:
    name: Integration Tests (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Fetch all tags for version integration tests

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Run integration tests
        run: go test -tags=integration -v ./pkg/oauth/... ./cmd/feedmix/...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: v2.9.0
          args: --timeout=5m

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Full history for gitleaks

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Run gitleaks (PII/secrets scanner)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.4
          govulncheck ./...

      - name: Run gosec
        uses: securego/gosec@398ad549bbf1a51dc978fd966169f660c59774de # v2.23.0
        with:
          args: ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, contract-tests, integration-tests, lint, security]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Fetch all tags for versioning

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.24'
          cache: true

      - name: Build with version
        env:
          FEEDMIX_YOUTUBE_CLIENT_ID: ${{ secrets.FEEDMIX_YOUTUBE_CLIENT_ID }}
          FEEDMIX_YOUTUBE_CLIENT_SECRET: ${{ secrets.FEEDMIX_YOUTUBE_CLIENT_SECRET }}
        run: |
          VERSION=$(git describe --tags --always --dirty)
          LDFLAGS="-X main.version=$VERSION"
          LDFLAGS="$LDFLAGS -X main.clientID=${FEEDMIX_YOUTUBE_CLIENT_ID:-}"
          LDFLAGS="$LDFLAGS -X main.clientSecret=${FEEDMIX_YOUTUBE_CLIENT_SECRET:-}"
          go build -ldflags="$LDFLAGS" -v ./cmd/feedmix
          echo "Built version: $VERSION"

      - name: Verify binary
        run: ./feedmix --version

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    outputs:
      should_release: ${{ steps.version.outputs.should_release }}
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Get commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Determine bump type from conventional commit
          if [[ "$COMMIT_MSG" =~ ^feat(\(.*\))?!:|^[a-z]+(\(.*\))?!:|BREAKING[[:space:]]CHANGE ]]; then
            # Breaking change -> major bump
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif [[ "$COMMIT_MSG" =~ ^feat(\(.*\))?: ]]; then
            # Feature -> minor bump
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif [[ "$COMMIT_MSG" =~ ^fix(\(.*\))?: ]]; then
            # Fix -> patch bump
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          else
            # No release for other commit types (docs, chore, refactor, etc.)
            echo "No release needed for commit type"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION (${BUMP_TYPE} bump)"
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Create tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          git tag -a "$NEW_VERSION" -m "chore(release): $NEW_VERSION"
          git push origin "$NEW_VERSION"

  release-binaries:
    name: Release Binaries
    runs-on: ubuntu-latest
    needs: [semantic-release]
    if: needs.semantic-release.outputs.should_release == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: ${{ needs.semantic-release.outputs.new_version }}

      - uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
        with:
          go-version: '1.24'
          cache: true

      - name: Build release binaries
        env:
          FEEDMIX_YOUTUBE_CLIENT_ID: ${{ secrets.FEEDMIX_YOUTUBE_CLIENT_ID }}
          FEEDMIX_YOUTUBE_CLIENT_SECRET: ${{ secrets.FEEDMIX_YOUTUBE_CLIENT_SECRET }}
        run: |
          VERSION="${{ needs.semantic-release.outputs.new_version }}"
          LDFLAGS="-X main.version=$VERSION"
          LDFLAGS="$LDFLAGS -X main.clientID=${FEEDMIX_YOUTUBE_CLIENT_ID:-}"
          LDFLAGS="$LDFLAGS -X main.clientSecret=${FEEDMIX_YOUTUBE_CLIENT_SECRET:-}"
          mkdir -p dist
          for platform in linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64; do
            GOOS="${platform%/*}"
            GOARCH="${platform#*/}"
            out="dist/feedmix-$VERSION-$GOOS-$GOARCH"
            [ "$GOOS" = "windows" ] && out="${out}.exe"
            GOOS=$GOOS GOARCH=$GOARCH go build -ldflags "$LDFLAGS" -o "$out" ./cmd/feedmix
          done
          cd dist && sha256sum feedmix-* > checksums.txt

      - name: Create Draft Release
        id: create_release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ needs.semantic-release.outputs.new_version }}
          files: dist/*
          generate_release_notes: true
          draft: true

      - name: E2E Smoke Tests
        id: smoke_tests
        run: |
          chmod +x tests/e2e-smoke.sh
          ./tests/e2e-smoke.sh
        continue-on-error: true

      - name: Publish Release
        if: steps.smoke_tests.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.semantic-release.outputs.new_version }}"
          gh release edit "$VERSION" --draft=false --latest

      - name: Rollback on E2E Failure
        if: steps.smoke_tests.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.semantic-release.outputs.new_version }}"
          gh release delete "$VERSION" --yes --cleanup-tag
          echo "::error::E2E smoke tests failed. Release $VERSION rolled back."
          exit 1
